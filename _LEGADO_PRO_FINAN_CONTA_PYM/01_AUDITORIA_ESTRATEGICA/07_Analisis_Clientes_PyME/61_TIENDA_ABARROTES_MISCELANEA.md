# ğŸª PERFIL 61: TIENDA DE ABARROTES / MISCELÃNEA

> **El Rey del Retail Mexicano**
> **TAM:** 2,100,000 tienditas en MÃ©xico (ANTAD 2024)
> **FacturaciÃ³n Promedio:** $80,000-$250,000 MXN/mes
> **RÃ©gimen Fiscal:** RESICO o RIF (80% estÃ¡n en informal/semiformal)

---

## ğŸ“Š DATOS DEMOGRÃFICOS

| Atributo              | Valor                                          |
| :-------------------- | :--------------------------------------------- |
| **Nombre Ficticio**   | Don Pancho "El de la Esquina"                  |
| **Edad**              | 35-65 aÃ±os                                     |
| **UbicaciÃ³n**         | TODO MÃ©xico (colonias populares, pueblos)      |
| **Ingreso Mensual**   | $80,000-$250,000 MXN (margen 15-25%)           |
| **Margen Neto Real**  | $12,000-$62,500 MXN/mes (despuÃ©s de todo)      |
| **Horario**           | 7:00 AM - 10:00 PM (15 horas/dÃ­a, 7 dÃ­as)      |
| **Empleados**         | 0-2 (familiar no registrado)                   |
| **RÃ©gimen Ideal**     | RESICO (si factura) o RIF (transiciÃ³n)         |
| **SituaciÃ³n Digital** | 60% usa celular, 40% tiene tablet, 10% laptop  |

---

## ğŸ¯ JOBS TO BE DONE (JTBD)

```
"Cuando llegan 50 clientes en la hora pico de la tarde,
 quiero cobrar rÃ¡pido sin errores y sin que se caiga el sistema,
 para que no pierda ventas y mi cliente no se vaya a la otra tienda"
```

**Contexto Real MÃ©xico Profundo:**

- **Hora pico:** 6:00 PM - 8:00 PM (cuando la gente sale del trabajo)
- **Venta promedio:** $35-$120 MXN por ticket
- **Ventas/dÃ­a:** 150-400 transacciones
- **Internet:** Se cae 2-3 veces al dÃ­a (Telmex/Totalplay/Izzi inestable)
- **Electricidad:** Apagones 1-2 veces/semana en zonas rurales

---

## ğŸ˜° DOLORES PRINCIPALES (RETAIL ESPECÃFICO)

### 1. ğŸ”´ğŸ”´ğŸ”´ ROBO HORMIGA (El dolor #1)

**Intensidad:** ğŸ”´ğŸ”´ğŸ”´ EXTREMA | **Frecuencia:** Diario

**Realidad Mexicana:**

> "Tengo 800 productos. SÃ© que me roban pero no sÃ© QUÃ‰ ni CUÃNTO.
> Al final del mes me faltan $8,000 pesos y no sÃ© si fue robo,
> que regalÃ© algo a un familiar, o error de conteo."

**Neurociencia:** Impotencia aprendida + cortisol crÃ³nico

**PÃ©rdida Promedio:** $3,000-$12,000 MXN/mes (5-15% del margen neto)

---

### 2. ğŸ”´ğŸ”´ğŸ”´ FACTURA GLOBAL = PÃ‰RDIDA DE TIEMPO

**Intensidad:** ğŸ”´ğŸ”´ğŸ”´ ALTA | **Frecuencia:** Diaria (al cierre)

**Realidad:**

> "Al cerrar la caja tengo que:
>
> 1. Contar el efectivo
> 2. Cuadrar contra ventas
> 3. Entrar al portal del SAT
> 4. Hacer UNA factura con TODO lo que vendÃ­ en el dÃ­a
> 5. Rezar que el sistema no se caiga
> â†’ Me toma 30-45 minutos DIARIOS"

**Tiempo Perdido:** 15 horas/mes = $3,000 MXN en costo de oportunidad

---

### 3. ğŸ”´ğŸ”´ NO SÃ‰ CUÃNTO GANO REALMENTE

**Intensidad:** ğŸ”´ğŸ”´ ALTA | **Frecuencia:** Mensual

**ConfusiÃ³n Real:**

- VendÃ­ $220,000 MXN en el mes
- ComprÃ© mercancÃ­a por $165,000 MXN
- Â¿GanÃ© $55,000? âŒ
- **Realidad:** DespuÃ©s de luz ($1,200), agua ($400), renta ($8,000), gasolina camioneta ($3,500), empleado informal ($6,000), le quedan **$35,900 netos**

**No sabe calcular:** Margen bruto vs margen neto

---

### 4. ğŸ”´ğŸ”´ PRODUCTOS QUE NO SE VENDEN

**Intensidad:** ğŸ”´ğŸ”´ MEDIA | **Frecuencia:** Mensual

**Inventario Muerto:**

> "ComprÃ© 50 paquetes de galletas marca X porque me hicieron descuento.
> Llevo 4 meses con 38 paquetes sin vender.
> Ya ni me acuerdo cuÃ¡nto me costaron ni cuÃ¡ndo caducan."

**PÃ©rdida Promedio:** $2,000-$5,000 MXN/mes en inventario inmÃ³vil

---

### 5. ğŸ”´ EL SAT ME DA MIEDO

**Intensidad:** ğŸ”´ MEDIA | **Frecuencia:** Trimestral

**Ansiedad Fiscal:**

- No sabe si debe facturar o no
- Cree que "si facturo, me van a cobrar mucho impuesto"
- EscuchÃ³ que "el SAT estÃ¡ auditando tienditas"
- No entiende quÃ© es RESICO ni cuÃ¡nto pagarÃ­a realmente

---

## ğŸ’¡ SOLUCIÃ“N: MÃ“DULO "POS TIENDITA EXPRESS"

### Arquitectura Offline-First

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TABLET / CELULAR                          â”‚
â”‚  (Hardware mÃ­nimo: Android 8+, 2GB RAM, pantalla tÃ¡ctil)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   SVELTE 5 PWA APP     â”‚
         â”‚   (Installed locally)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                         â”‚
                  â–¼                         â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   IndexedDB         â”‚   â”‚  Service Worker      â”‚
      â”‚   (Offline Storage) â”‚   â”‚  (Background Sync)   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                         â”‚
                 â”‚  When Online            â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  ElysiaJS Backend API   â”‚
              â”‚  (Bun + PostgreSQL)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ STACK TECNOLÃ“GICO ESPECÃFICO

### Frontend (POS en Tablet/Celular)

```typescript
// package.json
{
  "dependencies": {
    "svelte": "^5.0.0",
    "@sveltejs/kit": "^2.0.0",
    "dexie": "^4.0.1", // IndexedDB wrapper
    "@zxing/browser": "^0.1.5", // Barcode scanner (cÃ¡mara)
    "vite-plugin-pwa": "^0.20.0" // PWA + Service Workers
  }
}
```

---

## ğŸ—„ï¸ SCHEMAS POSTGRESQL (Backend)

### Tabla: `pos_products` (CatÃ¡logo de Productos)

```sql
CREATE TABLE pos_products (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  name VARCHAR(255) NOT NULL, -- "Coca Cola 600ml"
  barcode VARCHAR(100), -- EAN-13: "7501234567890"
  category VARCHAR(100), -- "Bebidas", "Abarrotes", "Limpieza"
  cost_price DECIMAL(10,2) NOT NULL, -- $8.50 (costo de compra)
  sale_price DECIMAL(10,2) NOT NULL, -- $12.00 (precio de venta)
  current_stock INTEGER NOT NULL DEFAULT 0, -- 48 unidades
  min_stock INTEGER DEFAULT 10, -- Alerta de reorden
  supplier VARCHAR(255), -- "Coca-Cola FEMSA"
  image_url TEXT, -- Opcional (foto del producto)
  active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_pos_products_user ON pos_products(user_id);
CREATE INDEX idx_pos_products_barcode ON pos_products(user_id, barcode);
CREATE INDEX idx_pos_products_low_stock ON pos_products(user_id, current_stock)
  WHERE current_stock <= min_stock AND active = TRUE;
```

---

### Tabla: `pos_sales` (Ventas POS)

```sql
CREATE TABLE pos_sales (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  sale_number INTEGER NOT NULL, -- NÃºmero de ticket (autoincremental por dÃ­a)
  sale_date TIMESTAMP NOT NULL DEFAULT NOW(),
  items JSONB NOT NULL, -- Array de productos vendidos
  /*
    Estructura items:
    [
      {
        product_id: "uuid",
        name: "Coca Cola 600ml",
        qty: 2,
        unit_price: 12.00,
        subtotal: 24.00
      },
      ...
    ]
  */
  subtotal DECIMAL(12,2) NOT NULL, -- $124.50
  tax DECIMAL(12,2) NOT NULL, -- $0 (mayorÃ­a venta pÃºblico general sin IVA desglosado)
  discount DECIMAL(12,2) DEFAULT 0, -- $0
  total DECIMAL(12,2) NOT NULL, -- $124.50
  payment_method VARCHAR(50) NOT NULL, -- 'cash', 'card', 'transfer'
  cash_received DECIMAL(12,2), -- $200 (si pago en efectivo)
  cash_change DECIMAL(12,2), -- $75.50 (cambio)
  invoice_id UUID REFERENCES invoices(id), -- NULL si es venta sin factura
  global_invoice_id UUID, -- FK a factura global del dÃ­a
  synced BOOLEAN DEFAULT FALSE, -- FALSE si estÃ¡ en IndexedDB esperando sync
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_pos_sales_user_date ON pos_sales(user_id, sale_date);
CREATE INDEX idx_pos_sales_synced ON pos_sales(synced) WHERE synced = FALSE;
CREATE INDEX idx_pos_sales_global_invoice ON pos_sales(global_invoice_id);
```

---

### Tabla: `global_invoices` (Facturas Globales Diarias)

```sql
CREATE TABLE global_invoices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  invoice_date DATE NOT NULL,
  total_sales_count INTEGER NOT NULL, -- 287 ventas
  total_amount DECIMAL(12,2) NOT NULL, -- $34,567.50
  invoice_xml TEXT, -- XML del CFDI timbrado
  invoice_pdf_url TEXT, -- URL del PDF
  sat_uuid VARCHAR(100), -- Folio fiscal UUID del SAT
  status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'generated', 'error'
  error_message TEXT, -- Si falla el timbrado
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, invoice_date)
);

CREATE INDEX idx_global_invoices_user_date ON global_invoices(user_id, invoice_date);
```

---

## ğŸ¨ COMPONENTES SVELTE 5 (POS UI)

### 1. `POSMain.svelte` (Pantalla Principal)

```svelte
<script lang="ts">
  import { onMount } from 'svelte';
  import Dexie from 'dexie';
  import { BrowserMultiFormatReader } from '@zxing/browser';

  // IndexedDB Schema
  const db = new Dexie('FinanzasMX_POS');
  db.version(1).stores({
    sales: '++id, user_id, sale_date, synced',
    products: '++id, user_id, barcode, name'
  });

  // Reactive State (Svelte 5 Runes)
  let cart = $state<CartItem[]>([]);
  let searchQuery = $state('');
  let products = $state<Product[]>([]);
  let showScanner = $state(false);

  // Computed Values
  let subtotal = $derived(cart.reduce((sum, item) => sum + (item.price * item.qty), 0));
  let total = $derived(subtotal);
  let itemCount = $derived(cart.reduce((sum, item) => sum + item.qty, 0));

  // Cargar productos desde IndexedDB (fallback) o API
  onMount(async () => {
    try {
      // Intentar desde API (si hay internet)
      const response = await fetch('/api/pos/products', {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      if (response.ok) {
        products = await response.json();
        // Cachear en IndexedDB
        await db.products.bulkPut(products);
      } else {
        throw new Error('API offline');
      }
    } catch (error) {
      // Fallback: Cargar desde IndexedDB
      products = await db.products.toArray();
      console.log('âš ï¸ Modo Offline: Productos cargados desde IndexedDB');
    }
  });

  // Agregar producto al carrito
  function addToCart(product: Product) {
    const existing = cart.find(item => item.product_id === product.id);

    if (existing) {
      existing.qty += 1;
      cart = [...cart]; // Trigger reactivity
    } else {
      cart = [...cart, {
        product_id: product.id,
        name: product.name,
        qty: 1,
        unit_price: product.sale_price,
        subtotal: product.sale_price
      }];
    }
  }

  // Completar venta
  async function completeSale(paymentMethod: 'cash' | 'card') {
    const sale = {
      user_id: localStorage.getItem('user_id'),
      sale_date: new Date().toISOString(),
      items: cart,
      subtotal,
      tax: 0,
      total,
      payment_method: paymentMethod,
      synced: false
    };

    // Guardar en IndexedDB (siempre, offline-first)
    await db.sales.add(sale);

    // Intentar sincronizar si hay internet
    if (navigator.onLine) {
      try {
        await fetch('/api/pos/sales', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(sale)
        });

        // Marcar como sincronizado
        sale.synced = true;
      } catch (error) {
        console.log('âš ï¸ Venta guardada offline, se sincronizarÃ¡ despuÃ©s');
      }
    }

    // Imprimir ticket (opcional, WebUSB o Bluetooth)
    printTicket(sale);

    // Reset carrito
    cart = [];

    // Mostrar feedback
    alert(`âœ… Venta completada: $${total.toFixed(2)} MXN`);
  }

  // Escanear cÃ³digo de barras con cÃ¡mara
  async function startBarcodeScanner() {
    showScanner = true;
    const codeReader = new BrowserMultiFormatReader();

    try {
      const result = await codeReader.decodeOnceFromVideoDevice(
        undefined,
        document.getElementById('video-preview') as HTMLVideoElement
      );

      const barcode = result.getText();
      const product = products.find(p => p.barcode === barcode);

      if (product) {
        addToCart(product);
        showScanner = false;
      } else {
        alert('âŒ Producto no encontrado');
      }
    } catch (error) {
      console.error('Error escaneando:', error);
      showScanner = false;
    }
  }

  // Sincronizar ventas pendientes (background)
  $effect(() => {
    const syncInterval = setInterval(async () => {
      if (navigator.onLine) {
        const pendingSales = await db.sales.where('synced').equals(false).toArray();

        if (pendingSales.length > 0) {
          console.log(`ğŸ”„ Sincronizando ${pendingSales.length} ventas...`);

          for (const sale of pendingSales) {
            try {
              await fetch('/api/pos/sales', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(sale)
              });

              // Marcar como sincronizado
              await db.sales.update(sale.id, { synced: true });
            } catch (error) {
              console.error('Error sincronizando venta:', error);
              break; // Reintentar despuÃ©s
            }
          }
        }
      }
    }, 30000); // Cada 30 segundos

    return () => clearInterval(syncInterval);
  });
</script>

<div class="pos-container">
  <!-- Header -->
  <header class="pos-header">
    <h1>ğŸª POS Tiendita Express</h1>
    <div class="status">
      {#if navigator.onLine}
        <span class="online">ğŸŸ¢ En lÃ­nea</span>
      {:else}
        <span class="offline">ğŸ”´ Offline</span>
      {/if}
    </div>
  </header>

  <!-- Main Grid -->
  <div class="pos-grid">
    <!-- Left: Productos -->
    <aside class="products-panel">
      <div class="search-bar">
        <input
          type="text"
          bind:value={searchQuery}
          placeholder="ğŸ” Buscar producto..."
        />
        <button onclick={startBarcodeScanner} class="scan-btn">
          ğŸ“· Escanear
        </button>
      </div>

      <div class="products-grid">
        {#each products.filter(p =>
          p.name.toLowerCase().includes(searchQuery.toLowerCase())
        ) as product}
          <button
            class="product-card"
            onclick={() => addToCart(product)}
          >
            <div class="product-name">{product.name}</div>
            <div class="product-price">${product.sale_price}</div>
            <div class="product-stock">
              {product.current_stock} unid.
            </div>
          </button>
        {/each}
      </div>
    </aside>

    <!-- Right: Carrito -->
    <main class="cart-panel">
      <h2>Carrito ({itemCount} items)</h2>

      <div class="cart-items">
        {#each cart as item}
          <div class="cart-item">
            <span class="item-name">{item.name}</span>
            <input
              type="number"
              bind:value={item.qty}
              min="1"
              class="item-qty"
            />
            <span class="item-price">${(item.unit_price * item.qty).toFixed(2)}</span>
            <button onclick={() => cart = cart.filter(i => i !== item)}>
              âŒ
            </button>
          </div>
        {/each}
      </div>

      <!-- Total -->
      <div class="cart-total">
        <h3>Total: ${total.toFixed(2)} MXN</h3>
      </div>

      <!-- Botones de Pago -->
      <div class="payment-buttons">
        <button
          class="btn-pay cash"
          onclick={() => completeSale('cash')}
          disabled={cart.length === 0}
        >
          ğŸ’µ Efectivo
        </button>
        <button
          class="btn-pay card"
          onclick={() => completeSale('card')}
          disabled={cart.length === 0}
        >
          ğŸ’³ Tarjeta
        </button>
      </div>
    </main>
  </div>

  <!-- Scanner Modal -->
  {#if showScanner}
    <div class="scanner-modal">
      <video id="video-preview" width="100%" height="auto"></video>
      <button onclick={() => showScanner = false}>âŒ Cerrar</button>
    </div>
  {/if}
</div>

<style>
  .pos-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: var(--surface-1);
  }

  .pos-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--size-3);
    background: var(--brand);
    color: white;
  }

  .pos-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: var(--size-2);
    flex: 1;
    overflow: hidden;
    padding: var(--size-2);
  }

  .products-panel {
    display: flex;
    flex-direction: column;
    gap: var(--size-2);
    overflow-y: auto;
  }

  .search-bar {
    display: flex;
    gap: var(--size-2);
  }

  .search-bar input {
    flex: 1;
    padding: var(--size-3);
    font-size: var(--font-size-3);
    border: 1px solid var(--surface-3);
    border-radius: var(--radius-2);
  }

  .scan-btn {
    padding: var(--size-3) var(--size-4);
    background: var(--brand);
    color: white;
    border: none;
    border-radius: var(--radius-2);
    cursor: pointer;
    font-size: var(--font-size-2);
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: var(--size-2);
  }

  .product-card {
    padding: var(--size-3);
    background: white;
    border: 2px solid var(--surface-2);
    border-radius: var(--radius-2);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .product-card:hover {
    border-color: var(--brand);
    transform: scale(1.05);
  }

  .product-name {
    font-weight: 600;
    margin-bottom: var(--size-1);
    font-size: var(--font-size-1);
  }

  .product-price {
    font-size: var(--font-size-3);
    color: var(--brand);
    font-weight: 700;
  }

  .product-stock {
    font-size: var(--font-size-0);
    color: var(--text-2);
    margin-top: var(--size-1);
  }

  .cart-panel {
    display: flex;
    flex-direction: column;
    gap: var(--size-2);
    background: white;
    padding: var(--size-3);
    border-radius: var(--radius-2);
    box-shadow: var(--shadow-3);
  }

  .cart-items {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: var(--size-2);
  }

  .cart-item {
    display: grid;
    grid-template-columns: 2fr 60px 80px 40px;
    gap: var(--size-2);
    align-items: center;
    padding: var(--size-2);
    background: var(--surface-1);
    border-radius: var(--radius-1);
  }

  .item-qty {
    width: 60px;
    padding: var(--size-1);
    text-align: center;
    border: 1px solid var(--surface-3);
    border-radius: var(--radius-1);
  }

  .item-price {
    font-weight: 600;
    text-align: right;
  }

  .cart-total {
    padding: var(--size-3);
    background: var(--surface-2);
    border-radius: var(--radius-2);
    text-align: center;
  }

  .cart-total h3 {
    font-size: var(--font-size-5);
    color: var(--brand);
  }

  .payment-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--size-2);
  }

  .btn-pay {
    padding: var(--size-4);
    font-size: var(--font-size-3);
    font-weight: 700;
    border: none;
    border-radius: var(--radius-2);
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-pay.cash {
    background: var(--green-6);
    color: white;
  }

  .btn-pay.card {
    background: var(--blue-6);
    color: white;
  }

  .btn-pay:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: var(--shadow-3);
  }

  .btn-pay:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .scanner-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  /* Responsive Tablet */
  @media (max-width: 1024px) {
    .pos-grid {
      grid-template-columns: 1fr;
    }

    .products-grid {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
  }
</style>
```

---

### 2. `GlobalInvoiceButton.svelte` (Cierre de Caja)

```svelte
<script lang="ts">
  let isGenerating = $state(false);
  let lastInvoice = $state<GlobalInvoice | null>(null);

  async function generateGlobalInvoice() {
    isGenerating = true;

    try {
      const response = await fetch('/api/pos/close-day', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      if (response.ok) {
        lastInvoice = await response.json();
        alert(`âœ… Factura Global generada: ${lastInvoice.total_sales_count} ventas por $${lastInvoice.total_amount} MXN`);
      } else {
        throw new Error('Error generando factura');
      }
    } catch (error) {
      alert('âŒ Error: ' + error.message);
    } finally {
      isGenerating = false;
    }
  }
</script>

<button
  class="close-day-btn"
  onclick={generateGlobalInvoice}
  disabled={isGenerating}
>
  {#if isGenerating}
    â³ Generando Factura Global...
  {:else}
    ğŸ§¾ Cerrar Caja (Factura Global)
  {/if}
</button>

{#if lastInvoice}
  <div class="invoice-summary">
    <h3>âœ… Factura Global del DÃ­a</h3>
    <p><strong>Ventas:</strong> {lastInvoice.total_sales_count}</p>
    <p><strong>Total:</strong> ${lastInvoice.total_amount} MXN</p>
    <a href={lastInvoice.invoice_pdf_url} target="_blank">
      ğŸ“„ Ver PDF
    </a>
  </div>
{/if}

<style>
  .close-day-btn {
    padding: var(--size-4);
    background: var(--orange-6);
    color: white;
    border: none;
    border-radius: var(--radius-2);
    font-size: var(--font-size-3);
    font-weight: 700;
    cursor: pointer;
    width: 100%;
  }

  .close-day-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .invoice-summary {
    margin-top: var(--size-3);
    padding: var(--size-3);
    background: var(--green-1);
    border: 2px solid var(--green-6);
    border-radius: var(--radius-2);
  }
</style>
```

---

## ğŸ”Œ ENDPOINTS ELYSIAJS (BACKEND)

### 1. GET `/api/pos/products` (Listar Productos)

```typescript
import { Elysia, t } from 'elysia';
import { db } from '../db';
import { posProducts } from '../db/schema';
import { eq } from 'drizzle-orm';
import { authMiddleware } from '../middleware/auth';

export const posRoutes = new Elysia({ prefix: '/pos' })
  .use(authMiddleware)
  .get('/products', async ({ user }) => {
    const products = await db.select().from(posProducts)
      .where(eq(posProducts.user_id, user.id));

    return products;
  })

  // POST /pos/products (Crear Producto)
  .post('/products', async ({ user, body }) => {
    const newProduct = await db.insert(posProducts).values({
      user_id: user.id,
      name: body.name,
      barcode: body.barcode,
      category: body.category,
      cost_price: body.cost_price,
      sale_price: body.sale_price,
      current_stock: body.current_stock || 0,
      min_stock: body.min_stock || 10,
      supplier: body.supplier
    }).returning();

    return newProduct[0];
  }, {
    body: t.Object({
      name: t.String(),
      barcode: t.Optional(t.String()),
      category: t.String(),
      cost_price: t.Number(),
      sale_price: t.Number(),
      current_stock: t.Optional(t.Number()),
      min_stock: t.Optional(t.Number()),
      supplier: t.Optional(t.String())
    })
  })

  // POST /pos/sales (Registrar Venta)
  .post('/sales', async ({ user, body }) => {
    const sale = await db.insert(posSales).values({
      user_id: user.id,
      sale_date: new Date(),
      items: body.items,
      subtotal: body.subtotal,
      tax: body.tax || 0,
      total: body.total,
      payment_method: body.payment_method,
      cash_received: body.cash_received,
      cash_change: body.cash_change,
      synced: true
    }).returning();

    // Actualizar inventario
    for (const item of body.items) {
      await db.update(posProducts)
        .set({
          current_stock: sql`current_stock - ${item.qty}`
        })
        .where(eq(posProducts.id, item.product_id));
    }

    return sale[0];
  }, {
    body: t.Object({
      items: t.Array(t.Object({
        product_id: t.String(),
        name: t.String(),
        qty: t.Number(),
        unit_price: t.Number(),
        subtotal: t.Number()
      })),
      subtotal: t.Number(),
      tax: t.Optional(t.Number()),
      total: t.Number(),
      payment_method: t.Union([t.Literal('cash'), t.Literal('card'), t.Literal('transfer')]),
      cash_received: t.Optional(t.Number()),
      cash_change: t.Optional(t.Number())
    })
  })

  // POST /pos/close-day (Cierre de Caja + Factura Global)
  .post('/close-day', async ({ user }) => {
    const today = new Date().toISOString().split('T')[0];

    // Obtener ventas del dÃ­a sin factura global
    const sales = await db.select().from(posSales)
      .where(
        and(
          eq(posSales.user_id, user.id),
          sql`DATE(sale_date) = ${today}`,
          isNull(posSales.global_invoice_id)
        )
      );

    if (sales.length === 0) {
      throw new Error('No hay ventas para facturar');
    }

    const totalAmount = sales.reduce((sum, s) => sum + parseFloat(s.total), 0);

    // Generar Factura Global en Facturapi
    const invoice = await facturapi.invoices.create({
      customer: {
        legal_name: 'PUBLICO EN GENERAL',
        tax_id: 'XAXX010101000',
        email: user.email
      },
      items: [{
        quantity: 1,
        product: {
          description: `Venta pÃºblica general del ${today}`,
          product_key: '01010101',
          price: totalAmount,
          tax_included: true
        }
      }],
      payment_form: '01', // Efectivo
      use: 'S01' // Sin efectos fiscales (pÃºblico general)
    });

    // Registrar Factura Global
    const globalInvoice = await db.insert(globalInvoices).values({
      user_id: user.id,
      invoice_date: today,
      total_sales_count: sales.length,
      total_amount: totalAmount,
      invoice_xml: invoice.xml,
      invoice_pdf_url: invoice.pdf_custom_section || invoice.pdf,
      sat_uuid: invoice.uuid,
      status: 'generated'
    }).returning();

    // Asociar ventas a factura global
    await db.update(posSales)
      .set({ global_invoice_id: globalInvoice[0].id })
      .where(
        and(
          eq(posSales.user_id, user.id),
          sql`DATE(sale_date) = ${today}`,
          isNull(posSales.global_invoice_id)
        )
      );

    // Enviar notificaciÃ³n WhatsApp
    await sendWhatsAppNotification(user.phone, {
      type: 'global_invoice_generated',
      data: {
        sales_count: sales.length,
        total: totalAmount,
        pdf_url: invoice.pdf
      }
    });

    return globalInvoice[0];
  });
```

---

## ğŸ“± NOTIFICACIÃ“N WHATSAPP (BAILEYS)

```typescript
// whatsapp/templates.ts
export const globalInvoiceTemplate = (data: {
  sales_count: number;
  total: number;
  pdf_url: string;
}) => `
âœ… *Cierre de Caja Exitoso*

ğŸ“Š *Resumen del DÃ­a:*
â€¢ Ventas: ${data.sales_count}
â€¢ Total: $${data.total.toFixed(2)} MXN

ğŸ§¾ *Factura Global Generada*
Descarga tu PDF aquÃ­:
${data.pdf_url}

ğŸ’¡ *Tip:* Esta factura ya estÃ¡ reportada al SAT automÃ¡ticamente.

---
_FinanzasMX - Tu tiendita mÃ¡s profesional_ ğŸª
`;
```

---

## ğŸ¯ ESTRATEGIA BOOTSTRAP (SIN PAID ADS)

### Canales Gratuitos EspecÃ­ficos

| Canal                              | Estrategia                                                  | ConversiÃ³n Esperada |
| :--------------------------------- | :---------------------------------------------------------- | :-----------------: |
| **Mercados de Abastos**            | Demo en vivo en Central de Abastos CDMX/Guadalajara        |     ğŸ”´ğŸ”´ğŸ”´ 10%     |
| **Grupos WhatsApp Tenderos**       | "Tenderos CDMX", "MiscelÃ¡neas MÃ©xico" (50k+ miembros)      |      ğŸ”´ğŸ”´ 5%       |
| **ANTAD / ANPEC**                  | AsociaciÃ³n Nacional de Tiendas (ponencias gratuitas)        |      ğŸ”´ğŸ”´ 8%       |
| **TikTok/Instagram Reels**         | "POV: Cierras tu tienda en 3 clics" (viral potencial)      |      ğŸ”´ğŸ”´ 7%       |
| **Distribuidores (Coca-Cola, Bimbo)** | Partner con repartidores que recomiendan a tenderos     |     ğŸ”´ğŸ”´ğŸ”´ 12%     |

### Contenido Viral EspecÃ­fico

**TikTok/Instagram Reel (30 segundos):**

```
ğŸ¬ ESCENA:
[00:00] Don Pancho contando efectivo manualmente (hora 11:00 PM)
[00:05] Texto: "Llevo 40 minutos cerrando la caja... ğŸ˜«"
[00:08] Switch a tablet con FinanzasMX
[00:10] 1 CLIC: "Cerrar Caja"
[00:12] 2 CLICS: "Generar Factura Global"
[00:15] WhatsApp notification: "âœ… Factura enviada al SAT"
[00:18] Don Pancho sonriendo
[00:20] Texto: "Ahora cierro en 3 minutos y me voy a cenar ğŸŒ®"
[00:25] CTA: "Link en bio - Prueba GRATIS 30 dÃ­as"

ğŸµ Audio: Cumbia mexicana trendy
ğŸ“Š Hooks: #TenderosMX #MiscelÃ¡neasMÃ©xico #SATFÃ¡cil
```

---

## ğŸ’° MODELO DE PRICING

| Plan       | Precio        | LÃ­mites                    | Target                    |
| :--------- | :------------ | :------------------------- | :------------------------ |
| **GRATIS** | $0/mes        | 50 ventas/mes              | Test, tienditas tiny      |
| **BÃSICO** | $199/mes      | 500 ventas/mes, 1 usuario  | MiscelÃ¡nea chica          |
| **PRO**    | $349/mes      | 2,000 ventas/mes, 2 users  | Tienda mediana            |
| **PREMIUM**| $599/mes      | Ilimitado, 5 users, multisucursal | Cadena de tienditas |

---

## ğŸ“Š TAM Y PROYECCIONES

### Mercado Total Addressable

- **Tiendas de Abarrotes en MÃ©xico:** 2,100,000 (ANTAD 2024)
- **% con potencial digital:** 25% = 525,000 tiendas
- **% dispuestas a pagar software:** 10% = 52,500 tiendas
- **Target AÃ±o 1:** 0.5% = 2,625 clientes

### ProyecciÃ³n ARR AÃ±o 1

```
2,625 clientes Ã— $349/mes promedio Ã— 12 meses = $10,992,750 MXN/aÃ±o
```

**ARR AÃ±o 1 (conservador):** **$11M MXN** (~$610k USD)

---

## ğŸš€ ROI PARA EL CLIENTE

### Ahorro Tangible

| Concepto                      | Sin FinanzasMX | Con FinanzasMX | Ahorro Mensual |
| :---------------------------- | :------------: | :------------: | :------------: |
| Tiempo cierre caja            |  15 hrs/mes    |   2 hrs/mes    |  **13 hrs**    |
| Costo contador (factura global)| $1,500/mes    |   $0 (auto)    |  **$1,500**    |
| PÃ©rdida por robo hormiga      |  $8,000/mes    |  $3,000/mes    |  **$5,000**    |
| Inventario muerto             |  $4,000/mes    |  $1,500/mes    |  **$2,500**    |
| **TOTAL AHORRO MENSUAL**      |                |                | **$9,000/mes** |

**ROI Anual:** $9,000 Ã— 12 = **$108,000 MXN ahorrados**
**InversiÃ³n:** $349 Ã— 12 = **$4,188 MXN**
**ROI:** **2,480%** (25x return)

---

## ğŸ” SEGURIDAD Y COMPLIANCE

### Cumplimiento SAT

- âœ… Factura Global automÃ¡tica (Regla 2.7.1.21 MiscelÃ¡nea Fiscal)
- âœ… CFDI 4.0 vÃ¡lido (timbrado Facturapi certificado)
- âœ… Reporte mensual automÃ¡tico de ingresos
- âœ… Registro de inventario (requerido para deducibilidad)

### Seguridad TÃ©cnica

- âœ… IndexedDB cifrado (datos sensibles)
- âœ… HTTPS only (TLS 1.3)
- âœ… Token JWT con refresh (15 min expiry)
- âœ… Rate limiting (prevenciÃ³n fraude)

---

## ğŸ“± EXPERIENCIA MÃ“VIL (MÃ‰XICO PROFUNDO)

### Requisitos MÃ­nimos Hardware

| Componente    | MÃ­nimo Requerido       | Ã“ptimo              |
| :------------ | :--------------------- | :------------------ |
| **Device**    | Tablet Android 8+      | Tablet Android 12+  |
| **RAM**       | 2 GB                   | 4 GB                |
| **Storage**   | 16 GB (8 GB libres)    | 32 GB               |
| **Pantalla**  | 7" tÃ¡ctil              | 10" tÃ¡ctil          |
| **ConexiÃ³n**  | WiFi intermitente OK   | WiFi + 4G           |
| **CÃ¡mara**    | 8 MP (para escÃ¡ner)    | 13 MP+              |

### Compatibilidad Internet

- âœ… Funciona 100% offline (IndexedDB + Service Workers)
- âœ… Sincroniza automÃ¡ticamente cuando hay conexiÃ³n
- âœ… Muestra indicador de "X ventas pendientes sync"
- âœ… No bloquea operaciÃ³n si falla sincronizaciÃ³n

---

## ğŸ“ ONBOARDING Y CAPACITACIÃ“N

### Tutorial Interactivo (5 minutos)

1. **Paso 1:** Registrar primer producto (con escÃ¡ner o manual)
2. **Paso 2:** Hacer venta de prueba ($10 pesos)
3. **Paso 3:** Cerrar caja y generar factura global
4. **Paso 4:** Ver reporte de ventas del dÃ­a

### Video TikTok/Instagram (60 segundos)

- "CÃ³mo Configurar Tu POS en 3 Minutos"
- "Factura Global: El Truco Que Todo Tendero Necesita"
- "AdiÃ³s Robo Hormiga: Controla Tu Inventario FÃ¡cil"

### Soporte WhatsApp Grupal

- Grupo de "Tenderos FinanzasMX" (comunidad de usuarios)
- Respuesta promedio: <5 minutos (horario 9 AM - 9 PM)
- FAQs automatizadas con bot

---

## ğŸ”® VISIÃ“N ESTRATÃ‰GICA 2026-2027

### Fase 2: MÃ³dulos Adicionales

1. **CrÃ©dito a Clientes** ("Fiadito Digital")
   - Registrar "Don Juan me debe $250"
   - Notificaciones automÃ¡ticas de cobro
   - Reporte de cartera vencida

2. **Promociones AutomÃ¡ticas**
   - "2Ã—1 en refrescos los viernes"
   - AplicaciÃ³n automÃ¡tica en POS

3. **AnÃ¡lisis Predictivo**
   - "Este sÃ¡bado venderÃ¡s 20% mÃ¡s Coca-Cola (compra mÃ¡s stock)"
   - Machine Learning basado en histÃ³rico

4. **Multisucursal**
   - 2-5 tienditas del mismo dueÃ±o
   - Dashboard consolidado

---

## âœ… CONCLUSIÃ“N PERFIL 61

**Problema Resuelto:** Factura Global manual + Robo Hormiga + Tiempo perdido

**Killer Feature:** POS Offline-First con Cierre de Caja automÃ¡tico (1 clic â†’ Factura al SAT)

**TAM:** 2.1M tienditas â†’ Target 52,500 digitalizables

**ARR AÃ±o 1:** $11M MXN (conservador)

**Complejidad TÃ©cnica:** ğŸ”´ğŸ”´ğŸ”´ğŸ”´ Muy Alta (Offline + Sync + EscÃ¡ner + IndexedDB)

**Prioridad ImplementaciÃ³n:** ğŸ”´ğŸ”´ğŸ”´ğŸ”´ CRÃTICA (perfil mÃ¡s masivo de MÃ©xico)

**Tiempo Estimado Desarrollo:** 18-22 dÃ­as

---

_Perfil completado: 9 Diciembre 2025_
_Stack validado: Svelte 5 + Bun + PostgreSQL + IndexedDB + Service Workers_
_DocumentaciÃ³n: 100% implementable_
